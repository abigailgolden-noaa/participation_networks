---
title: "Changes in salmon vessel participation 2023"
author: "Jameal Samhouri"
date: "Written 2024-01-11. Last Run `r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '3'
    toc_float: true
  pdf_document:
    highlight: haddock
    number_sections: yes
    toc: yes
    toc_depth: '3'
geometry: margin=1in
subtitle: Preparation for CCIEA ESR 2023-2024
fontsize: 11pt
---

# Setup

<br>
```{r "setup", include=FALSE}
if(!require("here")) {install.packages("here")}
library(here)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here())

## start time for full script
script_start_time <- Sys.time()
```
<br>

This script requires the following packages. 
```{r packages, message=FALSE, warning=FALSE}
if(!require("tidyverse")) {install.packages("tidyverse")}
if(!require("lubridate")) {install.packages("lubridate")}
if(!require("ggplot2")) {install.packages("ggplot2")}
if(!require("knitr")) {install.packages("knitr")}
if(!require("ggalluvial")) {install.packages("ggalluvial")}
if(!require("ggpubr")) {install.packages("ggpubr")}
if(!require("PNWColors")) {install.packages("PNWColors")}
if(!require("cowplot")) {install.packages("cowplot")}
if(!require("ggrepel")) {install.packages("ggrepel")}
```
<br>

# User Inputs 

Select your directories.
```{r}
## location of fish ticket with metiers assigned, metier key for each port group
indir = '/Users/jameal.samhouri/Documents/CCIEA Networks/processed'

## output file (including directory) for figures
figdir = 'results/figures'

## output file (including directory) for data frames
nonconoutdir = 'data/esr_2024'

## directory for species group key. not confidential
processdir <- "data/input"
```
<br>

Specify file name of the species groupings lookup key that contains labels for the network graphs.
```{r get_filenames}

myfile5 <- "spgrpn2_iea_key.csv"

```
<br>


Identify the crab years, port groups, and states that you would like to produce networks for. The port groups vector should include only those port groups which are present in the single data file produced with script 00. The states vector should include only those states which are present in the agid column of the fishtix data produced with script 00. 
```{r}
## (crab) years
years <- seq(2016,2022)

## IOPAC port groups
myports <- c("Puget Sound","North WA Coast","WA Coast","Other Coastal Washington","Astoria","Tillamook","Columbia River","Newport","Coos Bay","Brookings","Crescent City","Eureka","Morro Bay","Fort Bragg","Bodega Bay","San Francisco","San Diego","Monterey","Santa Barbara","Los Angeles","Unknown Ports" )

# wa_ports <- myports[1:4]
# or_ports <- myports[5:10]
# ca_ports <- myports[11:20]

## west coast states
mystates <- c("C", "O","W")

```
<br>

Some Dungeness crab landings may be recorded prior to the official opening date of the season as a part of domoic acid testing. We remove these landings because we are interested in flows of fishers between fisheries as a result of within-season activity.
```{r}
rm_crab = TRUE
```
<br>

For confidentiality, three or more salmon vessels must be participating in a port group for that port group to be included in the analysis 

```{r}

vessel_cutoff <- 3

```
<br>

We only include vessels that generate >=`$5,000` in total fisheries revenue each year and >=`$500` in revenue from individual fisheries.

```{r}

total_rev_cutoff <- 5000
indiv_rev_cutoff <- 500

```

# Read in data

Read in the landings data, from the file containing all fish tickets across port groups, within a single crab year.

NOTE: this step takes a while if you have not already made a compiled rds

NOTES FOR JAMEAL: 
1) read in fish ticket files with this naming convention: fish_tickets_crab2016_processed_for_networks_2024-01-18.csv

```{r}
# for(y in years){
#     tmptix <- read.csv(paste0(indir,"/fish_tickets_crab", y, "_processed_for_networks_2024-01-18.csv"), stringsAsFactors = FALSE) %>%
#     filter(IOPAC %in% myports)
# 
#     if(exists('fishtix')){
#       fishtix <- rbind(fishtix, tmptix)
#     } else { fishtix <- tmptix }
#   }
# rm(tmptix)
# 
# # some checks on species groups
# unique(fishtix$SPGRPN2)
# length(which(is.na(fishtix$SPGRPN2)))
# unique(fishtix[which(is.na(fishtix$SPGRPN2)),]$spid)
# unique(fishtix[which(is.na(fishtix$SPGRPN2)),]$year)
# unique(fishtix[which(is.na(fishtix$SPGRPN2)),]$agid)
# unique(fishtix[which(is.na(fishtix$SPGRPN2)),]$pcid)
# sum(is.na(fishtix$adj_afi_revenue))
# sum(is.na(fishtix$pounds))
# 
# # write out compiled fishtix for future use
# write_rds(fishtix, paste0(indir,"/fish_tickets_crab", min(years), "-", max(years), "_processed_for_networks_2024-01-18.rds"))

fishtix <- read_rds(paste0(indir,"/fish_tickets_crab", min(years), "-", max(years), "_processed_for_networks_2024-01-18.rds"))

```
<br>

Make sure that all dates are `Posixt` objects and species group labels are characters.
```{r}
#dates_df$odate <- mdy(dates_df$odate)
fishtix$tdate <- date(parse_date_time(fishtix$tdate, orders=c("ymd", "mdy")))
fishtix$SPGRPN2 = as.character(fishtix$SPGRPN2)
```
<br>

Species group names
```{r}

# Read in species group labels key #
spgrp_names <- read_csv(here::here(processdir,myfile5),
                       col_types = list(col_character(), col_character(), col_character()))

#### join sp group names to fishtix
fishtix <- fishtix %>%
  left_join(spgrp_names)

```

# Analyze salmon vessel participation

## Collect salmon vessels and tabulate

```{r salmon_vessels}

# create table of salmon vessels by crab yr and port group
salmon_vessels <- fishtix %>%
  group_by(crab_year, IOPAC) %>%
  filter(
    SPGRPN2 == '30'
  ) %>%
  dplyr::select(crab_year, IOPAC, drvid) %>%
  distinct() 

```

## Subset fishtix to salmon vessels only, 2017-2022

```{r subset_salmon}

salmontix <- fishtix %>%
  filter(
    drvid %in%  salmon_vessels$drvid &
      IOPAC %in%  salmon_vessels$IOPAC
  ) %>%
  filter(
    crab_year > 2016
  )
  

dim(salmontix)[1]/dim(fishtix %>% filter(crab_year > 2016))[1]


```
salmon vessels account for almost 60% of all fish tix across all commercial fisheries in pacfin from 2016-2023

## Determine which fisheries salmon vessels participate in and how much

### Annual data
Determine which fisheries salmon vessels in each port participated in during 2016-2022

Also summarise the number of salmon vessels participating in each fishery, and the total landings and revenue associated with each, by port and year. Make a nonconfidential data frame
```{r salmon_v_participation}

# confidential summary because it includes all fisheries even if <3 vessels participate
sv_participation_con <- salmontix %>%
  group_by(crab_year, IOPAC) %>%
  distinct(crab_year, IOPAC, species_group_2_label2, SPGRPN2) %>% 
  arrange(IOPAC, crab_year)

# ignoring sp groups
sv_bulkparticipation_noncon <- salmontix %>%
  group_by(crab_year, IOPAC) %>%
  summarise(
    num_vessels = length(unique(drvid)),
    total_rev = sum(adj_afi_revenue), 
    total_pounds = sum(pounds),
    .groups = 'drop'
  ) %>% 
  filter(
    num_vessels >= vessel_cutoff 
  ) %>%
  arrange(IOPAC, crab_year) 

# noncon summary
sv_participation_noncon <- salmontix %>%
  group_by(crab_year, IOPAC, species_group_2_label2, SPGRPN2) %>%
  summarise(
    num_vessels = length(unique(drvid)),
    total_rev = sum(adj_afi_revenue), 
    total_pounds = sum(pounds),
    .groups = 'drop'
  ) %>% 
  filter(
    num_vessels >= vessel_cutoff 
  ) %>%
  arrange(IOPAC, crab_year) 

salmon_only_noncon <- sv_participation_noncon %>%
  filter(
    SPGRPN2 == 30
  )

#sv_participation_noncon %>% kable #1073 rows

write_csv(sv_bulkparticipation_noncon, paste0(nonconoutdir,"/salmon_vessel_bulkparticipation_", min(years)+1, "-", max(years)+1, "_port_summaries.csv"))

write_csv(sv_participation_noncon, paste0(nonconoutdir,"/salmon_vessel_participation_", min(years)+1, "-", max(years)+1, "_port_summaries.csv"))


```

### Crab year 2017-2021 vs 2022 data
Determine which fisheries salmon vessels in each port participated in during 2017-2021 vs 2022

Also summarise the number of salmon vessels participating in each fishery, and the total landings and revenue associated with each, by port and year. Make a nonconfidential data frame
```{r salmon_v_participation_beforeafter}

# ignoring sp groups
sv_bulk_mean20172021_noncon <- sv_bulkparticipation_noncon %>%
  filter (crab_year %in% c(seq(2017,2021))) %>%
  group_by(IOPAC) %>%
  summarise(
    sd_num_vessels = sd(num_vessels, na.rm=TRUE),
    num_vessels = mean(num_vessels, na.rm=TRUE),
     
    sd_total_rev = sd(total_rev, na.rm=TRUE),
    total_rev = mean(total_rev, na.rm=TRUE),
    
    sd_total_pounds = sd(total_pounds, na.rm=TRUE),
    total_pounds = mean(total_pounds, na.rm=TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    crab_year = '2017-2021'
  ) %>%
  dplyr::select('crab_year','IOPAC', 'num_vessels', 'total_rev', 'total_pounds', 'sd_num_vessels', 'sd_total_rev', 'sd_total_pounds')

sv_bulk_2022_noncon <- sv_bulkparticipation_noncon %>%
  filter (crab_year == 2022) %>%
  mutate(
    crab_year = as.character(crab_year)
  )

sv_bulk_noncon <- sv_bulk_mean20172021_noncon %>% 
  bind_rows(sv_bulk_2022_noncon)

salmon_only_mean20172021_noncon <- salmon_only_noncon %>%
  filter (crab_year %in% c(seq(2017,2021))) %>%
  group_by(IOPAC) %>%
  summarise(
    sd_salmon_rev = sd(total_rev, na.rm=TRUE),
    salmon_rev = mean(total_rev, na.rm=TRUE),
    
    sd_salmon_pounds = sd(total_pounds, na.rm=TRUE),
    salmon_pounds = mean(total_pounds, na.rm=TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    crab_year = '2017-2021'
  ) %>%
  dplyr::select('crab_year','IOPAC', 'salmon_rev', 'salmon_pounds', 'sd_salmon_rev', 'sd_salmon_pounds')

salmon_only_2022_noncon <- salmon_only_noncon %>%
  filter (crab_year == 2022) %>%
  mutate(
    crab_year = as.character(crab_year)
  ) %>%
  rename(
    salmon_rev = total_rev,
    salmon_pounds = total_pounds
  ) %>%
  dplyr::select('crab_year','IOPAC', 'salmon_rev', 'salmon_pounds')

salmon_only_noncon <- salmon_only_mean20172021_noncon %>% 
  bind_rows(salmon_only_2022_noncon)

sv_bulk_noncon <- sv_bulk_noncon %>%
  left_join(salmon_only_noncon)

sv_ports_states <- sv_bulk_noncon %>%
  dplyr::select(IOPAC) %>%
  distinct() %>%
  mutate(
    state = c('Oregon','California','Oregon','Oregon','Oregon','California','California','California','California','California','Oregon','Washington','Washington','California','California','Oregon','None','Washington')
  )

sv_bulk_noncon <- sv_bulk_noncon %>%
  left_join(sv_ports_states)

sv_bulk_noncon %>% kable()

```

# Plot changes in salmon participation over time

```{r plot_portsetup}
allports <- c("Puget Sound","North WA Coast","WA Coast","Other Coastal Washington","Astoria","Tillamook","Columbia River","Newport","Coos Bay","Brookings","Crescent City","Eureka","Morro Bay","Fort Bragg","Bodega Bay","San Francisco","Monterey","Santa Barbara","Unknown Ports" ) # note LA and SD removed because no salmon vessels

ca_focal <- c('Santa Barbara','Morro Bay','Monterey','Bodega Bay')

ca_focal_pal <- pnw_palette("Bay", 4)

all_pal <- pnw_palette('Starfish', 4) # 1 color for each state and 1 for unlabeled points

canotfocal_pal <- pnw_palette("Starfish", 4)
or_pal <- pnw_palette("Cascades", 6)
wa_pal <- pnw_palette("Sailboat")[c(1,5:6)]

```

## 4 California ports

Compare number of salmon vessels participating in crab years 2017-2021 to 2022

```{r plot_bulk_sv_participation}
sv_bulk_noncon <- sv_bulk_noncon %>%
  mutate(
    salmon_rev_sizeforplotting = case_when(
      is.na(salmon_rev)==TRUE ~ 0.001,
      is.na(salmon_rev)==FALSE ~ salmon_rev/10^6
    )
  )

sv_bulk_noncon_ca <- sv_bulk_noncon %>%
  filter(IOPAC %in% ca_focal) #%>%
  # mutate(
  #   crab_year_IOPAC = paste0(crab_year,'_',IOPAC)
  # )

p_vessels <- ggplot(sv_bulk_noncon_ca, 
       aes(group = 1, y=num_vessels, x=crab_year, colour=IOPAC), #
       ) + 
  geom_point(aes(size = salmon_rev_sizeforplotting),
             alpha=.8, 
             position = position_dodge(width = 0.5)
    ) +
  geom_errorbar(
    aes(ymin = num_vessels - sd_num_vessels, ymax= num_vessels + sd_num_vessels), 
    na.rm = TRUE,
    alpha=.8, 
    position = position_dodge(width = 0.5),
    width = 0
    ) +
  #geom_jitter() +
  geom_line(alpha=0.8,
    position = position_dodge(width = 0.5)) +
  facet_wrap(vars(IOPAC), strip.position = "top", ncol = 5) +
  xlab("") +
  scale_x_discrete(labels = c('2017-2022','2022-2023')) +
  scale_colour_manual(values=rev(ca_focal_pal)) +
  ylab("Number of Active Salmon Vessels") +
  scale_radius(limits = c(0, NA), range = c(min(sv_bulk_noncon$salmon_rev_sizeforplotting), max(sv_bulk_noncon$salmon_rev_sizeforplotting)+2)) +
  guides(size = guide_legend(title="Port-Level Salmon Revenue\n(Millions USD)", override.aes = list(shape = 1)), colour='none') +
  theme_pubr(legend='bottom') + #c(0.8,0.8)
  theme(
    axis.text.x=element_text(size=10),
    axis.text.y=element_text(size=12),
    axis.title = element_text(size = 14),
    strip.background = element_rect(fill='white'),
    strip.text = element_text(size = 16)#,
    #strip.text.x = element_text(colour=rev(ca_focal_pal))
    #strip.text.x = element_blank()
  )

p_vessels

```

This plot shows the mean number of active salmon vessels from Nov 2016 through Oct 2022 compared to the total number of active salmon vessels from Nov 2022 to Oct 2023. Active here means that a vessel had commercial salmon landings anytime between Nov 2016 and Oct 2023, and participated in the fishery or any other commercial fishery during either the Nov 2016 through Oct 2022 or Nov 2022 to Oct 2023 time period.

Compare revenue of salmon vessels participating in crab years 2017-2021 to 2022

```{r plot_bulk_sv_rev}

p_rev <- ggplot(sv_bulk_noncon_ca, 
       aes(group = 1, y=total_rev/10^6, x=crab_year, colour=IOPAC)
       ) + #,shape=factor(IOPAC, levels = myports)
  geom_point(aes(size = salmon_rev_sizeforplotting),
             alpha=.8, 
             position = position_dodge(width = 0.5)
    ) +
  geom_errorbar(
    aes(ymin = (total_rev - sd_total_rev)/10^6, ymax= (total_rev + sd_total_rev)/10^6), 
    na.rm = TRUE,
    alpha=.8, 
    position = position_dodge(width = 0.5),
    width = 0
    ) +
  geom_line(alpha=0.8,
    position = position_dodge(width = 0.5)) +
  facet_wrap(vars(IOPAC), strip.position = "top", ncol = 5) +
  xlab("") +
  #ylim(c(0,max((sv_bulk_noncon_ca$total_rev + sv_bulk_noncon_ca$sd_total_rev)/10^6))) +
  scale_x_discrete(labels = c('2017-2022','2022-2023')) +
  ylab("Total Annual Commercial Fishing\nRevenue for Salmon Vessels\n(Millions USD)") +
  scale_colour_manual(values=rev(ca_focal_pal)) +
  scale_radius(limits = c(0, NA), range = c(min(sv_bulk_noncon$salmon_rev_sizeforplotting), max(sv_bulk_noncon$salmon_rev_sizeforplotting)+2)) +
  guides(size = guide_legend(title="Port-Level Salmon Revenue\n(Millions USD)", override.aes = list(shape = 1)), colour='none') +
  theme_pubr(legend='bottom') + #c(0.8,0.8)
  theme(
    axis.text.x=element_text(size=10),
    axis.text.y=element_text(size=12),
    axis.title = element_text(size = 14),
    strip.background = element_rect(fill='white'),
    #strip.text = element_text(size = 16)#,
    #strip.text.x = element_text(colour=rev(ca_focal_pal))
    strip.text = element_blank()
  )
  
p_rev

```

<!-- Compare landings of salmon vessels participating in crab years 2017-2021 to 2022 -->

<!-- ```{r plot_bulk_sv_landings} -->

<!-- p_lbs <- ggplot(sv_bulk_noncon_ca,  -->
<!--        aes(x=crab_year, y=total_pounds/10^6, colour=IOPAC, group=IOPAC) -->
<!--        ) + #,shape=factor(IOPAC, levels = myports) -->
<!--   geom_point(aes(size = salmon_rev_sizeforplotting), -->
<!--              alpha=.8,  -->
<!--              position = position_dodge(width = 0.5) -->
<!--     ) + -->
<!--   geom_errorbar( -->
<!--     aes(ymin = (total_pounds - 2*total_pounds)/10^6, ymax= (total_pounds + 2*total_pounds)/10^6),  -->
<!--     na.rm = TRUE, -->
<!--     alpha=.8,  -->
<!--     position = position_dodge(width = 0.5), -->
<!--     width = 0 -->
<!--     ) + -->
<!--   geom_line(alpha=0.8, -->
<!--     position = position_dodge(width = 0.5))+ -->
<!--   ylab("Total Annual Commercial Fishing\nLandings for Salmon Vessels\n(Millions of Pounds)") + -->
<!--   xlab("Time Period") + -->
<!--   scale_x_discrete(labels = c('2017-2022','2022-2023')) + -->
<!--   scale_colour_manual(values=rev(ca_focal_pal)) + -->
<!--   guides(colour=guide_legend(title="Port Group"), size = guide_legend(title="Salmon Revenue\n(Millions USD)", override.aes = list(shape = 1))) + -->
<!--   theme_pubr(legend="right")+ -->
<!--   theme( -->
<!--     axis.text.x=element_text(size=10), -->
<!--     axis.text.y=element_text(size=10), -->
<!--     axis.title = element_text(size = 14), -->
<!--     strip.background = element_blank(), -->
<!--     strip.text.x = element_blank() -->
<!--   ) -->

<!-- p_lbs -->

<!-- ``` -->

Glue participation and revenue together

```{r combine_plots}
p_row_ca <- plot_grid(
  p_vessels + theme(legend.position="none"),
  p_rev + theme(legend.position="none"),
  align = 'vh',
  labels = "auto", 
  hjust = -1,
  nrow = 2
)

legend_b <- get_legend(
  p_vessels + 
    #guides(colour = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)

# add the legend underneath the row we made earlier. Give it 10%
# of the height of one plot (via rel_heights).
plot_grid(p_row_ca,
          legend_b, 
          ncol = 1, 
          rel_heights = c(1, .1)
          )

# ggsave(paste0(figdir,'/ca_sv_part_rev.png'), height=6, width=14, units="in")
ggsave(paste0(figdir,'/ca_sv_part_rev_facet.png'), height=8, width=10, units="in")

```

```{r ca4_stats}

sv_bulk_noncon_ca %>%
  dplyr::select(
    IOPAC, crab_year, num_vessels, total_rev, total_pounds
  ) %>%
  pivot_wider(
    names_from = crab_year, values_from = c(num_vessels, total_rev, total_pounds)
  ) %>%
  group_by(IOPAC) %>%
  summarise(
    percent_change_num_vessels = 100*(`num_vessels_2017-2021` - num_vessels_2022)/`num_vessels_2017-2021`,
    percent_change_total_rev = 100*(`total_rev_2017-2021` - total_rev_2022)/`total_rev_2017-2021`,
    percent_change_total_pounds = 100*(`total_pounds_2017-2021` - total_pounds_2022)/`total_pounds_2017-2021`
  ) %>%
  kable()
  
```

Across California port groups, participation in commercial fisheries by salmon vessels that were active from 2017-2022 fell by as little as 5% (Santa Barbara) to more than 70% (Bodega Bay) during the 2022-2023 fishing season. Like participation, the total revenue from commercial fishing in 2022-2023 for these salmon vessels declined as well (54-64%) in all of these port groups except Santa Barbara. In Santa Barbara, commercial fishing revenue increased >90% in 2022-2023 compared to the average from 2017-2022.

Changes in participation by fishery can be found in salmon_vessel_participation_2017-2023_port_summaries.csv. This table only includes fisheries in which >=3 vessels participated.

These plots show (a) the mean number of active salmon vessels from Nov 2017 through Oct 2022 compared to the total number of active salmon vessels from Nov 2022 to Oct 2023, and (b) the mean revenue across all commercial fisheries on the west coast from Nov 2016 through Oct 2022 compared to the total commercial fishing revenue on the west coast from Nov 2022 to Oct 2023. Active here means that a vessel had commercial salmon landings anytime between Nov 2017 and Oct 2023, and participated in the fishery or any other commercial fishery during either the Nov 2017 through Oct 2022 or Nov 2022 to Oct 2023 time period.

Points represent averages (2017-2022) or totals (2022-2023) for each port group, and error bars reflect 1 standard deviation (2017-2022). Point size scales with the mean (2017-2022) or total (2022-2023) salmon revenue generated in each port. A fishing season is defined from November of year y through November of year (y+1), specifically week 46 of year y through week 45 of year (y+1), to capture the strong influence of the Dungeness crab fishery.


## All ports except 4 California ports

Subset to state-specific ports
```{r subset_bystate}
sv_bulk_noncon_allbut4ca <- sv_bulk_noncon %>%
  filter(!(IOPAC %in% ca_focal)) %>%
  filter(stat != 'None')

sv_bulk_noncon_canotfocal <- sv_bulk_noncon %>%
  filter(!(IOPAC %in% ca_focal)) %>%
  filter(state != 'None') %>%
  filter(state == 'California')

sv_bulk_noncon_wa <- sv_bulk_noncon %>%
  filter(state != 'None') %>%
  filter(state == 'Washington') %>%
  mutate(
    IOPAC_lat = factor(IOPAC, levels = c('Puget Sound','North WA Coast','WA Coast'))
  )

sv_bulk_noncon_or <- sv_bulk_noncon %>%
  filter(state != 'None') %>%
  filter(state == 'Oregon') %>%
  mutate(
    IOPAC_lat = factor(IOPAC, levels = c('Astoria','Columbia River','Tillamook','Newport','Coos Bay','Brookings'))
  )

```

### California not focal
Compare number of salmon vessels participating in crab years 2017-2021 to 2022

```{r plot_bulk_sv_participation_canotfocal}

p_vessels_canotfocal <- ggplot(sv_bulk_noncon_canotfocal, 
       aes(group = 1, y=num_vessels, x=crab_year, colour=IOPAC), #
       ) + 
  geom_point(aes(size = salmon_rev_sizeforplotting),
             alpha=.8, 
             position = position_dodge(width = 0.5)
    ) +
  geom_errorbar(
    aes(ymin = num_vessels - sd_num_vessels, ymax= num_vessels + sd_num_vessels), 
    na.rm = TRUE,
    alpha=.8, 
    position = position_dodge(width = 0.5),
    width = 0
    ) +
  #geom_jitter() +
  geom_line(alpha=0.8,
    position = position_dodge(width = 0.5)) +
  facet_wrap(vars(IOPAC), strip.position = "top", ncol = 5) +
  xlab("") +
  scale_x_discrete(labels = c('2017-2022','2022-2023')) +
  scale_colour_manual(values=rev(canotfocal_pal)) +
  ylab("Number of Active Salmon Vessels") +
  scale_radius(limits = c(0, NA), range = c(min(sv_bulk_noncon$salmon_rev_sizeforplotting), max(sv_bulk_noncon$salmon_rev_sizeforplotting)+2)) +
  guides(size = guide_legend(title="Port-Level Salmon Revenue\n(Millions USD)", override.aes = list(shape = 1)), colour='none') +
  theme_pubr(legend='bottom') + #c(0.8,0.8)
  theme(
    axis.text.x=element_text(size=10),
    axis.text.y=element_text(size=12),
    axis.title = element_text(size = 14),
    strip.background = element_rect(fill='white'),
    strip.text = element_text(size = 16)#,
    #strip.text.x = element_text(colour=rev(ca_focal_pal))
    #strip.text.x = element_blank()
  )

p_vessels_canotfocal

```

Compare revenue of salmon vessels participating in crab years 2017-2021 to 2022

```{r plot_bulk_sv_canotfocal}

p_rev_canotfocal <- ggplot(sv_bulk_noncon_canotfocal, 
       aes(group = 1, y=total_rev/10^6, x=crab_year, colour=IOPAC)
       ) + #,shape=factor(IOPAC, levels = myports)
  geom_point(aes(size = salmon_rev_sizeforplotting),
             alpha=.8, 
             position = position_dodge(width = 0.5)
    ) +
  geom_errorbar(
    aes(ymin = (total_rev - sd_total_rev)/10^6, ymax= (total_rev + sd_total_rev)/10^6), 
    na.rm = TRUE,
    alpha=.8, 
    position = position_dodge(width = 0.5),
    width = 0
    ) +
  geom_line(alpha=0.8,
    position = position_dodge(width = 0.5)) +
  facet_wrap(vars(IOPAC), strip.position = "top", ncol = 5) +
  xlab("") +
  #ylim(c(0,max((sv_bulk_noncon_ca$total_rev + sv_bulk_noncon_ca$sd_total_rev)/10^6))) +
  scale_x_discrete(labels = c('2017-2022','2022-2023')) +
  ylab("Total Annual Commercial Fishing\nRevenue for Salmon Vessels\n(Millions USD)") +
  scale_colour_manual(values=rev(canotfocal_pal)) +
  scale_radius(limits = c(0, NA), range = c(min(sv_bulk_noncon$salmon_rev_sizeforplotting), max(sv_bulk_noncon$salmon_rev_sizeforplotting)+2)) +
  guides(size = guide_legend(title="Port-Level Salmon Revenue\n(Millions USD)", override.aes = list(shape = 1)), colour='none') +
  theme_pubr(legend='bottom') + #c(0.8,0.8)
  theme(
    axis.text.x=element_text(size=10),
    axis.text.y=element_text(size=12),
    axis.title = element_text(size = 14),
    strip.background = element_rect(fill='white'),
    #strip.text = element_text(size = 16)#,
    #strip.text.x = element_text(colour=rev(ca_focal_pal))
    strip.text = element_blank()
  )
  
p_rev_canotfocal

```

Glue participation and revenue together - CA not focal

```{r combine_plots_canotfocal}
p_row_canotfocal <- plot_grid(
  p_vessels_canotfocal + theme(legend.position="none"),
  p_rev_canotfocal + theme(legend.position="none"),
  align = 'vh',
  labels = "auto", 
  hjust = -1,
  nrow = 2
)

legend_b_canotfocal <- get_legend(
  p_vessels_canotfocal + 
    #guides(colour = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)

# add the legend underneath the row we made earlier. Give it 10%
# of the height of one plot (via rel_heights).
p_row_canotfocal2 <- plot_grid(p_row_canotfocal,
          legend_b_canotfocal, 
          ncol = 1, 
          rel_heights = c(1, .1)
          )

# now add the title
title_canotfocal <- ggdraw() + 
  draw_label(
    "California",
    fontface = 'bold',
    size = 18,
    x = 0.5,
    hjust = 0
  )
  # ) +
  # theme(
  #   # add margin on the left of the drawing canvas,
  #   # so title is aligned with left edge of first plot
  #   plot.margin = margin(0, 7, 0, 7)
  # )

p_canotfocal2_final <- plot_grid(
  title_canotfocal, p_row_canotfocal2,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
)

p_canotfocal2_final

ggsave(paste0(figdir,'/canotfocal_sv_part_rev_facet.png'), height=8, width=10, units="in")

```

### Oregon
Compare number of salmon vessels participating in crab years 2017-2021 to 2022 - Oregon

```{r plot_bulk_sv_participation_or}

p_vessels_or <- ggplot(sv_bulk_noncon_or, 
       aes(group = 1, y=num_vessels, x=crab_year, colour=IOPAC_lat), #
       ) + 
  geom_point(aes(size = salmon_rev_sizeforplotting),
             alpha=.8, 
             position = position_dodge(width = 0.5)
    ) +
  geom_errorbar(
    aes(ymin = num_vessels - sd_num_vessels, ymax= num_vessels + sd_num_vessels), 
    na.rm = TRUE,
    alpha=.8, 
    position = position_dodge(width = 0.5),
    width = 0
    ) +
  #geom_jitter() +
  geom_line(alpha=0.8,
    position = position_dodge(width = 0.5)) +
  facet_wrap(vars(IOPAC_lat), strip.position = "top", nrow = 1) +
  xlab("") +
  scale_x_discrete(labels = c('2017-2022','2022-2023')) +
  scale_colour_manual(values=rev(or_pal)) +
  ylab("Number of Active Salmon Vessels") +
  scale_radius(limits = c(0, NA), range = c(min(sv_bulk_noncon$salmon_rev_sizeforplotting), max(sv_bulk_noncon$salmon_rev_sizeforplotting)+2)) +
  guides(size = guide_legend(title="Port-Level Salmon Revenue\n(Millions USD)", override.aes = list(shape = 1)), colour='none') +
  theme_pubr(legend='bottom') + #c(0.8,0.8)
  theme(
    axis.text.x=element_text(size=10),
    axis.text.y=element_text(size=12),
    axis.title = element_text(size = 14),
    strip.background = element_rect(fill='white'),
    strip.text = element_text(size = 16)#,
    #strip.text.x = element_text(colour=rev(ca_focal_pal))
    #strip.text.x = element_blank()
  )

p_vessels_or

```

Compare revenue of salmon vessels participating in crab years 2017-2021 to 2022 - Oregon

```{r plot_bulk_sv_or}

p_rev_or <- ggplot(sv_bulk_noncon_or, 
       aes(group = 1, y=total_rev/10^6, x=crab_year, colour=IOPAC_lat)
       ) + #,shape=factor(IOPAC, levels = myports)
  geom_point(aes(size = salmon_rev_sizeforplotting),
             alpha=.8, 
             position = position_dodge(width = 0.5)
    ) +
  geom_errorbar(
    aes(ymin = (total_rev - sd_total_rev)/10^6, ymax= (total_rev + sd_total_rev)/10^6), 
    na.rm = TRUE,
    alpha=.8, 
    position = position_dodge(width = 0.5),
    width = 0
    ) +
  geom_line(alpha=0.8,
    position = position_dodge(width = 0.5)) +
  facet_wrap(vars(IOPAC_lat), strip.position = "top", nrow = 1) +
  xlab("") +
  #ylim(c(0,max((sv_bulk_noncon_ca$total_rev + sv_bulk_noncon_ca$sd_total_rev)/10^6))) +
  scale_x_discrete(labels = c('2017-2022','2022-2023')) +
  ylab("Total Annual Commercial Fishing\nRevenue for Salmon Vessels\n(Millions USD)") +
  scale_colour_manual(values=rev(or_pal)) +
  scale_radius(limits = c(0, NA), range = c(min(sv_bulk_noncon$salmon_rev_sizeforplotting), max(sv_bulk_noncon$salmon_rev_sizeforplotting)+2)) +
  guides(size = guide_legend(title="Port-Level Salmon Revenue\n(Millions USD)", override.aes = list(shape = 1)), colour='none') +
  theme_pubr(legend='bottom') + #c(0.8,0.8)
  theme(
    axis.text.x=element_text(size=10),
    axis.text.y=element_text(size=12),
    axis.title = element_text(size = 14),
    strip.background = element_rect(fill='white'),
    #strip.text = element_text(size = 16)#,
    #strip.text.x = element_text(colour=rev(ca_focal_pal))
    strip.text = element_blank()
  )
  
p_rev_or

```

Glue participation and revenue together - Oregon

```{r combine_plots_or}
p_row_or <- plot_grid(
  p_vessels_or + theme(legend.position="none"),
  p_rev_or + theme(legend.position="none"),
  align = 'vh',
  labels = "auto", 
  hjust = -1,
  nrow = 2
)

legend_b_or <- get_legend(
  p_vessels_or + 
    #guides(colour = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)

# add the legend underneath the row we made earlier. Give it 10%
# of the height of one plot (via rel_heights).
p_row_or2 <- plot_grid(p_row_or,
          legend_b_or, 
          ncol = 1, 
          rel_heights = c(1, .1)
          )

# now add the title
title_or <- ggdraw() + 
  draw_label(
    "Oregon",
    fontface = 'bold',
    size = 18,
    x = 0.5,
    hjust = 0
  )
  # ) +
  # theme(
  #   # add margin on the left of the drawing canvas,
  #   # so title is aligned with left edge of first plot
  #   plot.margin = margin(0, 7, 0, 7)
  # )

p_or_final <- plot_grid(
  title_or, p_row_or2,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
)

p_or_final

ggsave(paste0(figdir,'/or_sv_part_rev_facet.png'), height=8, width=14, units="in")

```

### Washington
Compare number of salmon vessels participating in crab years 2017-2021 to 2022

```{r plot_bulk_sv_participation_wa}

p_vessels_wa <- ggplot(sv_bulk_noncon_wa, 
       aes(group = 1, y=num_vessels, x=crab_year, colour=IOPAC), #
       ) + 
  geom_point(aes(size = salmon_rev_sizeforplotting),
             alpha=.8, 
             position = position_dodge(width = 0.5)
    ) +
  geom_errorbar(
    aes(ymin = num_vessels - sd_num_vessels, ymax= num_vessels + sd_num_vessels), 
    na.rm = TRUE,
    alpha=.8, 
    position = position_dodge(width = 0.5),
    width = 0
    ) +
  #geom_jitter() +
  geom_line(alpha=0.8,
    position = position_dodge(width = 0.5)) +
  facet_wrap(vars(IOPAC), strip.position = "top", ncol = 3) +
  xlab("") +
  scale_x_discrete(labels = c('2017-2022','2022-2023')) +
  scale_colour_manual(values=rev(wa_pal)) +
  ylab("Number of Active Salmon Vessels") +
  scale_radius(limits = c(0, NA), range = c(min(sv_bulk_noncon$salmon_rev_sizeforplotting), max(sv_bulk_noncon$salmon_rev_sizeforplotting)+2)) +
  guides(size = guide_legend(title="Port-Level Salmon Revenue\n(Millions USD)", override.aes = list(shape = 1)), colour='none') +
  theme_pubr(legend='bottom') + #c(0.8,0.8)
  theme(
    axis.text.x=element_text(size=10),
    axis.text.y=element_text(size=12),
    axis.title = element_text(size = 14),
    strip.background = element_rect(fill='white'),
    strip.text = element_text(size = 16)#,
    #strip.text.x = element_text(colour=rev(ca_focal_pal))
    #strip.text.x = element_blank()
  )

p_vessels_wa

```

Compare revenue of salmon vessels participating in crab years 2017-2021 to 2022

```{r plot_bulk_sv_wa}

p_rev_wa <- ggplot(sv_bulk_noncon_wa, 
       aes(group = 1, y=total_rev/10^6, x=crab_year, colour=IOPAC)
       ) + #,shape=factor(IOPAC, levels = myports)
  geom_point(aes(size = salmon_rev_sizeforplotting),
             alpha=.8, 
             position = position_dodge(width = 0.5)
    ) +
  geom_errorbar(
    aes(ymin = (total_rev - sd_total_rev)/10^6, ymax= (total_rev + sd_total_rev)/10^6), 
    na.rm = TRUE,
    alpha=.8, 
    position = position_dodge(width = 0.5),
    width = 0
    ) +
  geom_line(alpha=0.8,
    position = position_dodge(width = 0.5)) +
  facet_wrap(vars(IOPAC), strip.position = "top", ncol = 3) +
  xlab("") +
  #ylim(c(0,max((sv_bulk_noncon_ca$total_rev + sv_bulk_noncon_ca$sd_total_rev)/10^6))) +
  scale_x_discrete(labels = c('2017-2022','2022-2023')) +
  ylab("Total Annual Commercial Fishing\nRevenue for Salmon Vessels\n(Millions USD)") +
  scale_colour_manual(values=rev(wa_pal)) +
  scale_radius(limits = c(0, NA), range = c(min(sv_bulk_noncon$salmon_rev_sizeforplotting), max(sv_bulk_noncon$salmon_rev_sizeforplotting)+2)) +
  guides(size = guide_legend(title="Port-Level Salmon Revenue\n(Millions USD)", override.aes = list(shape = 1)), colour='none') +
  theme_pubr(legend='bottom') + #c(0.8,0.8)
  theme(
    axis.text.x=element_text(size=10),
    axis.text.y=element_text(size=12),
    axis.title = element_text(size = 14),
    strip.background = element_rect(fill='white'),
    #strip.text = element_text(size = 16)#,
    #strip.text.x = element_text(colour=rev(ca_focal_pal))
    strip.text = element_blank()
  )
  
p_rev_wa

```

Glue participation and revenue together - WA

```{r combine_plots_wa}
p_row_wa <- plot_grid(
  p_vessels_wa + theme(legend.position="none"),
  p_rev_wa + theme(legend.position="none"),
  align = 'vh',
  labels = "auto", 
  hjust = -1,
  nrow = 2
)

legend_b_wa <- get_legend(
  p_vessels_wa + 
    #guides(colour = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)

# add the legend underneath the row we made earlier. Give it 10%
# of the height of one plot (via rel_heights).
p_row_wa2 <- plot_grid(p_row_wa,
          legend_b_wa, 
          ncol = 1, 
          rel_heights = c(1, .1)
          )

# now add the title
title_wa <- ggdraw() + 
  draw_label(
    "Washington",
    fontface = 'bold',
    size = 18,
    x = 0.5,
    hjust = 0
  )
  # ) +
  # theme(
  #   # add margin on the left of the drawing canvas,
  #   # so title is aligned with left edge of first plot
  #   plot.margin = margin(0, 7, 0, 7)
  # )

p_wa_final <- plot_grid(
  title_wa, p_row_wa2,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
)

p_wa_final

ggsave(paste0(figdir,'/wa_sv_part_rev_facet.png'), height=8, width=10, units="in")

```

### Combine CA not focal, OR, and WA

```{r combine_plots_all}
p_row_all <- plot_grid(
  p_vessels_wa + theme(legend.position="none"),
  p_rev_wa + theme(legend.position="none"),
  p_vessels_or + theme(legend.position="none"),
  p_rev_or + theme(legend.position="none"),
  p_vessels_canotfocal + theme(legend.position="none"),
  p_rev_canotfocal + theme(legend.position="none"),
  align = 'vh',
  labels = "auto", 
  hjust = -1,
  nrow = 6
)

legend_b_all <- get_legend(
  p_vessels_canotfocal + 
    #guides(colour = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)

# add the legend underneath the row we made earlier. Give it 10%
# of the height of one plot (via rel_heights).
p_row_all2 <- plot_grid(p_row_all,
          legend_b_all, 
          ncol = 1, 
          rel_heights = c(1, .1)
          )

p_row_all2

ggsave(paste0(figdir,'/all_sv_part_rev_facet_commonlegend.png'), height=11, width=8, units="in")

p_row_all_glue <- plot_grid(p_wa_final,
          p_or_final,
          p_canotfocal2_final,
          nrow=3
          )
p_row_all_glue

ggsave(paste0(figdir,'/all_sv_part_rev_facet_glue.png'), height=11, width=8, units="in")

```


<!-- Old way of plotting -->
<!-- ```{r plot_bulk_sv_participation_all} -->


<!-- p_vessels_all <- ggplot(sv_bulk_noncon_allbut4ca,  -->
<!--        aes(x=crab_year, y=num_vessels, colour=state, group=IOPAC) -->
<!--        ) +  -->
<!--   geom_text_repel( -->
<!--     aes(label = ifelse(crab_year == "2022", IOPAC, ""), colour = ifelse(crab_year == "2022", state, ""), fontface = 'bold'),  -->
<!--     show.legend  = FALSE, -->
<!--     #nudge_x = 0.4,  -->
<!--     direction = "x",  -->
<!--     vjust = 2, -->
<!--     hjust = -0.5, -->
<!--     point.padding = 0.2, -->
<!--     position = position_dodge(width = 0.5), -->
<!--     segment.linetype = 'dotted',    -->
<!--     min.segment.length = 0 -->
<!--   ) +   -->
<!--   geom_point(aes(size = salmon_rev_sizeforplotting), -->
<!--              alpha=.8,  -->
<!--              position = position_dodge(width = 0.5) -->
<!--     ) + -->
<!--   geom_errorbar( -->
<!--     aes(ymin = num_vessels - 2*sd_num_vessels, ymax= num_vessels + 2*sd_num_vessels),  -->
<!--     na.rm = TRUE, -->
<!--     alpha=.8,  -->
<!--     position = position_dodge(width = 0.5), -->
<!--     width = 0 -->
<!--     ) + -->
<!--   geom_line(alpha=0.8, -->
<!--     position = position_dodge(width = 0.5))+ -->
<!--   xlab("Time Period") + -->
<!--   scale_x_discrete(labels = c('2017-2022','2022-2023')) + -->
<!--   ylab("Number of Active Salmon Vessels") + -->
<!--   facet_wrap(vars(state), ncol=1) + -->
<!--   scale_colour_manual(values=all_pal, guide = "none") + -->
<!--   guides(size = guide_legend(title="Salmon Revenue\n(Millions USD)", override.aes = list(shape = 1))) + -->
<!--   theme_pubr(legend='bottom')+ #legend="none" -->
<!--   theme( -->
<!--     axis.text.x=element_text(size=10), -->
<!--     axis.text.y=element_text(size=10), -->
<!--     axis.title = element_text(size = 14), -->
<!--     strip.background = element_blank(), -->
<!--     strip.text.x = element_text(size = 14) -->
<!--   ) -->

<!-- p_vessels_all -->

<!-- ``` -->

<!-- This plot shows the mean number of active salmon vessels from Nov 2016 through Oct 2022 compared to the total number of active salmon vessels from Nov 2022 to Oct 2023. Active here means that a vessel had commercial salmon landings anytime between Nov 2016 and Oct 2023, and participated in the fishery or any other commercial fishery during either the Nov 2016 through Oct 2022 or Nov 2022 to Oct 2023 time period. -->

<!-- Compare revenue of salmon vessels participating in crab years 2017-2021 to 2022 -->

<!-- ```{r plot_bulk_sv_rev_all} -->

<!-- p_rev_all <- ggplot(sv_bulk_noncon_allbut4ca,  -->
<!--        aes(x=crab_year, y=total_rev/10^6, colour=state, group=IOPAC) -->
<!--        ) + #,shape=factor(IOPAC, levels = myports) -->
<!--   geom_text_repel( -->
<!--     aes(label = ifelse(crab_year == "2022", IOPAC, ""), colour = ifelse(crab_year == "2022", state, ""), fontface = 'bold'),  -->
<!--     show.legend  = FALSE, -->
<!--     #nudge_x = 0.4,  -->
<!--     direction = "x",  -->
<!--     vjust = 2, -->
<!--     hjust = -0.5, -->
<!--     point.padding = 0.2, -->
<!--     position = position_dodge(width = 0.5), -->
<!--     segment.linetype = 'dotted',    -->
<!--     min.segment.length = 0 -->
<!--   ) +   -->
<!--   geom_point(aes(size = salmon_rev_sizeforplotting), -->
<!--              alpha=.8,  -->
<!--              position = position_dodge(width = 0.5) -->
<!--     ) + -->
<!--   geom_errorbar( -->
<!--     aes(ymin = (total_rev - 2*sd_total_rev)/10^6, ymax= (total_rev + 2*sd_total_rev)/10^6),  -->
<!--     na.rm = TRUE, -->
<!--     alpha=.8,  -->
<!--     position = position_dodge(width = 0.5), -->
<!--     width = 0 -->
<!--     ) + -->
<!--   geom_line(alpha=0.8, -->
<!--     position = position_dodge(width = 0.5))+ -->
<!--   xlab("Time Period") + -->
<!--   scale_x_discrete(labels = c('2017-2022','2022-2023')) + -->
<!--   facet_wrap(vars(state), ncol=1) + -->
<!--   scale_colour_manual(values=all_pal, guide = "none") + -->
<!--   guides(size = guide_legend(title="Salmon Revenue\n(Millions USD)", override.aes = list(shape = 1))) + -->
<!--   ylab("Total Annual Commercial Fishing\nRevenue for Salmon Vessels\n(Millions USD)") + -->
<!--   theme_pubr(legend="bottom")+ -->
<!--   theme( -->
<!--     axis.text.x=element_text(size=10), -->
<!--     axis.text.y=element_text(size=10), -->
<!--     axis.title = element_text(size = 14), -->
<!--     strip.background = element_blank(), -->
<!--     strip.text.x = element_text(size = 14) -->
<!--   ) -->

<!-- p_rev_all -->

<!-- ``` -->

<!-- Compare landings of salmon vessels participating in crab years 2017-2021 to 2022 -->

<!-- ```{r plot_bulk_sv_landings_all} -->

<!-- p_lbs_all <- ggplot(sv_bulk_noncon_allbut4ca,  -->
<!--        aes(x=crab_year, y=total_pounds/10^6, colour=state, group=IOPAC) -->
<!--        ) + #,shape=factor(IOPAC, levels = myports) -->
<!--   geom_text_repel( -->
<!--     aes(label = ifelse(crab_year == "2022", IOPAC, ""), colour = ifelse(crab_year == "2022", state, ""), fontface = 'bold'),  -->
<!--     show.legend  = FALSE, -->
<!--     #nudge_x = 0.4,  -->
<!--     direction = "x",  -->
<!--     vjust = 2, -->
<!--     hjust = -0.5, -->
<!--     point.padding = 0.2, -->
<!--     position = position_dodge(width = 0.5), -->
<!--     segment.linetype = 'dotted',    -->
<!--     min.segment.length = 0 -->
<!--   ) +   -->
<!--   geom_point(aes(size = salmon_rev_sizeforplotting), -->
<!--              alpha=.8,  -->
<!--              position = position_dodge(width = 0.5) -->
<!--     ) + -->
<!--   geom_errorbar( -->
<!--     aes(ymin = (total_pounds - 2*sd_total_pounds)/10^6, ymax= (total_pounds + 2*sd_total_pounds)/10^6),  -->
<!--     na.rm = TRUE, -->
<!--     alpha=.8,  -->
<!--     position = position_dodge(width = 0.5), -->
<!--     width = 0 -->
<!--     ) + -->
<!--   geom_line(alpha=0.8, -->
<!--     position = position_dodge(width = 0.5))+ -->
<!--   ylab("Total Annual Commercial Fishing\nLandings for Salmon Vessels\n(Millions of Pounds)") + -->
<!--   xlab("Time Period") + -->
<!--   scale_x_discrete(labels = c('2017-2022','2022-2023')) + -->
<!--   scale_y_continuous(trans = 'pseudo_log') + -->
<!--   facet_wrap(vars(state), ncol=1) + -->
<!--   scale_colour_manual(values=all_pal, guide = "none") + -->
<!--   guides(size = guide_legend(title="Salmon Revenue\n(Millions USD)", override.aes = list(shape = 1))) + -->
<!--   #guides(colour=guide_legend(title="Port Group")) + -->
<!--   theme_pubr(legend="bottom")+ -->
<!--   theme( -->
<!--     axis.text.x=element_text(size=10), -->
<!--     axis.text.y=element_text(size=10), -->
<!--     axis.title = element_text(size = 14), -->
<!--     strip.background = element_blank(), -->
<!--     strip.text.x = element_text(size = 14) -->
<!--   ) -->

<!-- p_lbs_all -->

<!-- ``` -->

<!-- Glue participation and revenue together -->

<!-- ```{r combine_plots_all} -->
<!-- p_row_all <- plot_grid( -->
<!--   p_vessels_all + theme(legend.position="none"), -->
<!--   p_rev_all + theme(legend.position="none"), -->
<!--   align = 'vh', -->
<!--   labels = "auto",  -->
<!--   hjust = -1, -->
<!--   nrow = 1 -->
<!-- ) -->

<!-- legend_b_all <- get_legend( -->
<!--   p_vessels_all +  -->
<!--     guides(size = guide_legend(title="Salmon Revenue\n(Millions USD)", override.aes = list(shape = 1)), -->
<!--            nrow=1) + -->
<!--     theme(legend.position = "bottom") -->
<!-- ) -->

<!-- # add the legend underneath the row we made earlier. Give it 10% -->
<!-- # of the height of one plot (via rel_heights). -->
<!-- plot_grid(p_row_all, -->
<!--           legend_b_all,  -->
<!--           ncol = 1,  -->
<!--           rel_heights = c(1, .1) -->
<!--           ) -->

<!-- ggsave(paste0(figdir,'/allbut4ca_facet_sv_part_rev.png'), height=6, width=14, units="in") -->

<!-- ``` -->

```{r allbutca4_stats}

sv_bulk_noncon_allbut4ca %>%
  dplyr::select(
    IOPAC, crab_year, num_vessels, total_rev, total_pounds
  ) %>%
  pivot_wider(
    names_from = crab_year, values_from = c(num_vessels, total_rev, total_pounds)
  ) %>%
  group_by(IOPAC) %>%
  summarise(
    percent_change_num_vessels = 100*(`num_vessels_2017-2021` - num_vessels_2022)/`num_vessels_2017-2021`,
    percent_change_total_rev = 100*(`total_rev_2017-2021` - total_rev_2022)/`total_rev_2017-2021`,
    percent_change_total_pounds = 100*(`total_pounds_2017-2021` - total_pounds_2022)/`total_pounds_2017-2021`
  ) %>%
  kable()
  
```

<!-- By CA port -->
<!-- ```{r v_participation_alluvial_ plot} -->

<!-- # probably easiest to start by converting df to wide format -->

<!-- sv_participation_noncon_wide <- sv_participation_noncon %>% -->
<!--   pivot_wider( -->
<!--     names_from = species_group_2_label2, -->
<!--     values_from = c(num_vessels, total_rev, total_pounds) -->
<!--   ) -->

<!-- ggplot(data = titanic_wide, -->
<!--        aes(axis1 = Class, axis2 = Sex, axis3 = Age, -->
<!--            y = Freq)) + -->
<!--   scale_x_discrete(limits = c("Class", "Sex", "Age"), expand = c(.2, .05)) + -->
<!--   xlab("Demographic") + -->
<!--   geom_alluvium(aes(fill = Survived)) + -->
<!--   geom_stratum() + -->
<!--   geom_text(stat = "stratum", aes(label = after_stat(stratum))) + -->
<!--   theme_minimal() + -->
<!--   ggtitle("passengers on the maiden voyage of the Titanic", -->
<!--           "stratified by demographics and survival") -->

<!-- ggplot(data = sv_participation_noncon %>% filter(IOPAC == 'Bodega Bay'), -->
<!--        aes(x = species_group_2_label2, stratum = stratum, alluvium = alluvium, -->
<!--            y = num_vessels, label = species_group_2_label2)) + -->
<!--   geom_alluvium(aes(fill = num_vessels)) + -->
<!--   geom_stratum() + geom_text(stat = "stratum") + -->
<!--   theme_minimal() -->
<!--   # theme_minimal() + -->
<!--   # ggtitle("passengers on the maiden voyage of the Titanic", -->
<!--   #         "stratified by demographics and survival") -->



<!-- ``` -->
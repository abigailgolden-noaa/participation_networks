---
title: "Changes in salmon vessel participation 2023"
author: "Jameal Samhouri"
date: "Written 2024-01-11. Last Run `r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '3'
  pdf_document:
    highlight: haddock
    number_sections: yes
    toc: yes
    toc_depth: '3'
geometry: margin=1in
subtitle: Preparation for CCIEA ESR 2023-2024
fontsize: 11pt
---

# Setup

<br>
```{r "setup", include=FALSE}
if(!require("here")) {install.packages("here")}
library(here)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here())

## start time for full script
script_start_time <- Sys.time()
```
<br>

This script requires the following packages. 
```{r packages, message=FALSE, warning=FALSE}
if(!require("tidyverse")) {install.packages("tidyverse")}
if(!require("lubridate")) {install.packages("lubridate")}
if(!require("ggplot2")) {install.packages("ggplot2")}
if(!require("knitr")) {install.packages("knitr")}
if(!require("ggalluvial")) {install.packages("ggalluvial")}
if(!require("ggpubr")) {install.packages("ggpubr")}
```
<br>

# User Inputs 

Select your directories.
```{r}
## location of fish ticket with metiers assigned, metier key for each port group
indir = '/Users/jameal.samhouri/Documents/CCIEA Networks/processed'

## output file (including directory) for figures
figdir = 'results/figures'

## output file (including directory) for data frames
nonconoutdir = 'data/esr_2024'

## directory for species group key. not confidential
processdir <- "data/input"
```
<br>

Specify file name of the species groupings lookup key that contains labels for the network graphs.
```{r get_filenames}

myfile5 <- "spgrpn2_iea_key.csv"

```
<br>


Identify the crab years, port groups, and states that you would like to produce networks for. The port groups vector should include only those port groups which are present in the single data file produced with script 00. The states vector should include only those states which are present in the agid column of the fishtix data produced with script 00. 
```{r}
## (crab) years
years <- seq(2016,2022)

## IOPAC port groups
myports <- c("Puget Sound","North WA Coast","WA Coast","Other Coastal Washington","Astoria","Tillamook","Columbia River","Newport","Coos Bay","Brookings","Crescent City","Eureka","Morro Bay","Fort Bragg","Bodega Bay","San Francisco","San Diego","Monterey","Santa Barbara","Los Angeles","Unknown Ports" )

# wa_ports <- myports[1:4]
# or_ports <- myports[5:10]
# ca_ports <- myports[11:20]

## west coast states
mystates <- c("C", "O","W")

```
<br>

Some Dungeness crab landings may be recorded prior to the official opening date of the season as a part of domoic acid testing. We remove these landings because we are interested in flows of fishers between fisheries as a result of within-season activity.
```{r}
rm_crab = TRUE
```
<br>

For confidentiality, three or more salmon vessels must be participating in a port group for that port group to be included in the analysis 

```{r}

vessel_cutoff <- 3

```
<br>

# Read in data

Read in the landings data, from the file containing all fish tickets across port groups, within a single crab year.

NOTE: this step takes a while if you have not already made a compiled rds

NOTES FOR JAMEAL: 
1) read in fish ticket files with this naming convention: fish_tickets_crab2016_processed_for_networks_2024-01-10.csv

```{r}
# for(y in years){
#     tmptix <- read.csv(paste0(indir,"/fish_tickets_crab", y, "_processed_for_networks_2024-01-10.csv"), stringsAsFactors = FALSE) %>%
#     filter(IOPAC %in% myports)
#     
#     if(exists('fishtix')){
#       fishtix <- rbind(fishtix, tmptix)
#     } else { fishtix <- tmptix }
#   }
# rm(tmptix)
# 
# # some checks on species groups
# unique(fishtix$SPGRPN2)
# length(which(is.na(fishtix$SPGRPN2)))
# unique(fishtix[which(is.na(fishtix$SPGRPN2)),]$spid)
# unique(fishtix[which(is.na(fishtix$SPGRPN2)),]$year)
# unique(fishtix[which(is.na(fishtix$SPGRPN2)),]$agid)
# unique(fishtix[which(is.na(fishtix$SPGRPN2)),]$pcid)

# write out compiled fishtix for future use
# write_rds(fishtix, paste0(indir,"/fish_tickets_crab", min(years), "-", max(years), "_processed_for_networks_2024-01-10.rds"))

fishtix <- read_rds(paste0(indir,"/fish_tickets_crab", min(years), "-", max(years), "_processed_for_networks_2024-01-10.rds"))

```
<br>

Make sure that all dates are `Posixt` objects and species group labels are characters.
```{r}
#dates_df$odate <- mdy(dates_df$odate)
fishtix$tdate <- date(parse_date_time(fishtix$tdate, orders=c("ymd", "mdy")))
fishtix$SPGRPN2 = as.character(fishtix$SPGRPN2)
```
<br>

Species group names
```{r}

# Read in species group labels key #
spgrp_names <- read_csv(here::here(processdir,myfile5),
                       col_types = list(col_character(), col_character(), col_character()))

#### join sp group names to fishtix
fishtix <- fishtix %>%
  left_join(spgrp_names)

```

# Analyze salmon vessel participation

## Collect salmon vessels and tabulate

```{r salmon_vessels}

# create table of salmon vessels by crab yr and port group
salmon_vessels <- fishtix %>%
  group_by(crab_year, IOPAC) %>%
  filter(
    SPGRPN2 == '30'
  ) %>%
  dplyr::select(crab_year, IOPAC, drvid) %>%
  distinct() 

```

## Subset fishtix to salmon vessels only

```{r subset_salmon}

salmontix <- fishtix %>%
  filter(
    drvid %in%  salmon_vessels$drvid
  )

dim(salmontix)[1]/dim(fishtix)[1]
# salmon vessels account for almost 60% of all fish tix across all commercial fisheries in pacfin from 2016-2023

```

## Determine which fisheries salmon vessels participate in and how much

### Annual data
Determine which fisheries salmon vessels in each port participated in during 2016-2022

Also summarise the number of salmon vessels participating in each fishery, and the total landings and revenue associated with each, by port and year. Make a nonconfidential data frame
```{r salmon_v_participation}

# confidential summary because it includes all fisheries even if <3 vessels participate
sv_participation_con <- salmontix %>%
  group_by(crab_year, IOPAC) %>%
  distinct(crab_year, IOPAC, species_group_2_label2, SPGRPN2) %>% 
  arrange(IOPAC, crab_year)

# ignoring sp groups
sv_bulkparticipation_noncon <- salmontix %>%
  group_by(crab_year, IOPAC) %>%
  summarise(
    num_vessels = length(unique(drvid)),
    total_rev = sum(adj_revenue), # come back to this to include afi_revenue instead
    total_pounds = sum(pounds),
    .groups = 'drop'
  ) %>% 
  filter(
    num_vessels >= vessel_cutoff 
  ) %>%
  arrange(IOPAC, crab_year) 

# noncon summary
sv_participation_noncon <- salmontix %>%
  group_by(crab_year, IOPAC, species_group_2_label2, SPGRPN2) %>%
  summarise(
    num_vessels = length(unique(drvid)),
    total_rev = sum(adj_revenue), # come back to this to include afi_revenue instead
    total_pounds = sum(pounds),
    .groups = 'drop'
  ) %>% 
  filter(
    num_vessels >= vessel_cutoff 
  ) %>%
  arrange(IOPAC, crab_year) 

#sv_participation_noncon %>% kable #1073 rows

write_csv(sv_bulkparticipation_noncon, paste0(nonconoutdir,"/salmon_vessel_bulkparticipation_", min(years), "-", max(years), "_port_summaries.csv"))

write_csv(sv_participation_noncon, paste0(nonconoutdir,"/salmon_vessel_participation_", min(years), "-", max(years), "_port_summaries.csv"))


```

### Crab year 2017-2021 vs 2022 data
Determine which fisheries salmon vessels in each port participated in during 2017-2021 vs 2022

Also summarise the number of salmon vessels participating in each fishery, and the total landings and revenue associated with each, by port and year. Make a nonconfidential data frame
```{r salmon_v_participation_beforeafter}

# ignoring sp groups
sv_bulk_mean20172021_noncon <- sv_bulkparticipation_noncon %>%
  filter (crab_year %in% c(seq(2017,2021))) %>%
  group_by(IOPAC) %>%
  summarise(
    num_vessels = mean(num_vessels, na.rm=TRUE),
    sd_num_vessels = sd(num_vessels, na.rm=TRUE), 
    total_rev = mean(total_rev, na.rm=TRUE),# come back to this to include afi_revenue instead
    sd_total_rev = sd(total_rev, na.rm=TRUE),# come back to this to include afi_revenue instead
    total_pounds = mean(total_pounds, na.rm=TRUE),
    sd_total_pounds = sd(total_pounds, na.rm=TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    crab_year = '2017-2021'
  ) %>%
  dplyr::select('crab_year','IOPAC', 'num_vessels', 'total_rev', 'total_pounds', 'sd_num_vessels', 'sd_total_rev', 'sd_total_pounds')

sv_bulk_2022_noncon <- sv_bulkparticipation_noncon %>%
  filter (crab_year == 2022) %>%
  mutate(
    crab_year = as.character(crab_year)
  )

sv_bulk_noncon <- sv_bulk_mean20172021_noncon %>% 
  bind_rows(sv_bulk_2022_noncon)



```

# Plot changes in salmon participation over time

Compare number of salmon vessels participating in crab years 2017-2021 to 2022

```{r plot_bulk_sv_participation}
myports <- c("Puget Sound","North WA Coast","WA Coast","Other Coastal Washington","Astoria","Tillamook","Columbia River","Newport","Coos Bay","Brookings","Crescent City","Eureka","Morro Bay","Fort Bragg","Bodega Bay","San Francisco","San Diego","Monterey","Santa Barbara","Los Angeles","Unknown Ports" )

ca_focal <- c('Santa Barbara','Morro Bay','Monterey','Bodega Bay')

ggplot(sv_bulk_noncon %>% filter(IOPAC %in% ca_focal),
       aes(x=crab_year,y=num_vessels, colour=IOPAC, group=IOPAC)) + #,shape=factor(IOPAC, levels = myports)
  geom_point(alpha=.8,size=3)+
  #geom_jitter() +
  geom_line(alpha=0.8)+
  #scale_colour_gradientn(colours = pal, name=str_wrap("Initial Biomass",20), guide = gc)+
    xlab("Time Period") +
  # scale_shape_discrete(name = "Course correction timing",
  #                      labels = c("Lag (75)", "Sync (50)", "Lead (25)")) +
  # scale_x_discrete(limits = c('sq','abrupt', 'gradual'), labels = c(str_wrap('Status Quo',20),str_wrap('Abrupt Climate Adaptive',20), str_wrap('Gradual Climate Adaptive',20))) +
  ylab("Number of Active Salmon Vessels") +
  #ggtitle('Step Decrease in K') +
  theme_pubr(legend="right")+
  theme(
    axis.text.x=element_text(size=10),
    axis.text.y=element_text(size=10),
    axis.title = element_text(size = 14),
    strip.background = element_blank(),
    strip.text.x = element_blank()
  )


```

By port
```{r v_participation_alluvial_ plot}

# probably easiest to start by converting df to wide format

sv_participation_noncon_wide <- sv_participation_noncon %>%
  pivot_wider(
    names_from = species_group_2_label2,
    values_from = c(num_vessels, total_rev, total_pounds)
  )

ggplot(data = titanic_wide,
       aes(axis1 = Class, axis2 = Sex, axis3 = Age,
           y = Freq)) +
  scale_x_discrete(limits = c("Class", "Sex", "Age"), expand = c(.2, .05)) +
  xlab("Demographic") +
  geom_alluvium(aes(fill = Survived)) +
  geom_stratum() +
  geom_text(stat = "stratum", aes(label = after_stat(stratum))) +
  theme_minimal() +
  ggtitle("passengers on the maiden voyage of the Titanic",
          "stratified by demographics and survival")
 
ggplot(data = sv_participation_noncon %>% filter(IOPAC == 'Bodega Bay'),
       aes(x = species_group_2_label2, stratum = stratum, alluvium = alluvium,
           y = num_vessels, label = species_group_2_label2)) +
  geom_alluvium(aes(fill = num_vessels)) +
  geom_stratum() + geom_text(stat = "stratum") +
  theme_minimal()
  # theme_minimal() +
  # ggtitle("passengers on the maiden voyage of the Titanic",
  #         "stratified by demographics and survival")



```